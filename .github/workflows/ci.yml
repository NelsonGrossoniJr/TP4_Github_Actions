# Nome do workflow que aparecerá na interface do GitHub Actions
name: CI/CD Pipeline

# Define os eventos que disparam a execução do workflow
on:
  push:
    branches: [ main, master]

  pull_request:
    branches: [ main, master] 
  workflow_dispatch:

# Define os jobs (tarefas) que serão executados
jobs:
  build-and-test:
    name: Build e Testes
    runs-on: ubuntu-latest
    
    steps:
      # Passo 1: Baixar o código do repositório
      - name: Checkout do código
        uses: actions/checkout@v4
        
      # Passo 2: Configurar o ambiente Java e Maven
      - name: Configurar Java 21 e Maven
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          
      # Passo 3: Configurar Chrome para testes Selenium
      - name: Configurar Chrome para testes Selenium
        run: |
          google-chrome --version || echo "Chrome não encontrado, mas WebDriverManager vai gerenciar"
          export DISPLAY=:99
          
      # Passo 4: Compilar o projeto (sem executar testes ainda)
      - name: Compilar o projeto
        run: mvn clean compile package -DskipTests
          
      # Passo 5: Iniciar a aplicação em background
      - name: Iniciar aplicação em background
        run: |
          nohup mvn exec:java -Dexec.mainClass="org.example.App" > app.log 2>&1 &
          echo $! > app.pid
          sleep 3
          
      # Passo 6: Aguardar aplicação estar pronta
      - name: Aguardar aplicação estar pronta
        run: |
          echo "Aguardando aplicação iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/items > /dev/null 2>&1; then
              echo "Aplicação está pronta!"
              exit 0
            fi
            echo "Tentativa $i/30 - aguardando..."
            sleep 2
          done
          echo "Aplicação não iniciou a tempo!"
          exit 1
          
      # Passo 7: Executar testes (incluindo testes Selenium)
      - name: Executar testes
        env:
          CI: true
        run: mvn test
        
      # Passo 8: Parar a aplicação
      - name: Parar aplicação
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            echo "Aplicação parada"
          fi
          # Mostra os logs da aplicação para debug (se necessário)
          if [ -f app.log ]; then
            echo "=== Logs da aplicação ==="
            cat app.log
          fi
        
      # Passo 9: Fazer upload dos arquivos gerados (artefatos)
      - name: Upload artefatos de build
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: target/*.jar
          retention-days: 7

