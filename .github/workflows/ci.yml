# Nome do workflow que aparecerÃ¡ na interface do GitHub Actions
name: CI/CD Pipeline - Staging e ProduÃ§Ã£o

# Define os eventos que disparam a execuÃ§Ã£o do workflow
on:
  push:
    branches: 
      - main
      - master
      - staging
  pull_request:
    branches: 
      - main
      - master
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        type: choice
        options:
          - staging
          - production

# Define variÃ¡veis de ambiente globais
env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Dmaven.repo.local=${{ github.workspace }}/.m2/repository'

# Define os jobs (tarefas) que serÃ£o executados
jobs:
  # Job de Build e Testes - Executa sempre
  build-and-test:
    name: Build e Testes
    runs-on: ubuntu-latest
    
    steps:
      # Passo 1: Baixar o cÃ³digo do repositÃ³rio
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      # Passo 2: Configurar o ambiente Java e Maven
      - name: Configurar Java 21 e Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
          
      # Passo 3: Configurar Chrome para testes Selenium
      - name: Configurar Chrome para testes Selenium
        run: |
          google-chrome --version || echo "Chrome nÃ£o encontrado, mas WebDriverManager vai gerenciar"
          export DISPLAY=:99
          
      # Passo 4: Compilar o projeto (sem executar testes ainda)
      - name: Compilar o projeto
        run: mvn clean compile package -DskipTests
          
      # Passo 5: Iniciar a aplicaÃ§Ã£o em background
      - name: Iniciar aplicaÃ§Ã£o em background
        run: |
          nohup mvn exec:java -Dexec.mainClass="org.example.App" > app.log 2>&1 &
          echo $! > app.pid
          sleep 3
          
      # Passo 6: Aguardar aplicaÃ§Ã£o estar pronta
      - name: Aguardar aplicaÃ§Ã£o estar pronta
        run: |
          echo "Aguardando aplicaÃ§Ã£o iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/items > /dev/null 2>&1; then
              echo "AplicaÃ§Ã£o estÃ¡ pronta!"
              exit 0
            fi
            echo "Tentativa $i/30 - aguardando..."
            sleep 2
          done
          echo "AplicaÃ§Ã£o nÃ£o iniciou a tempo!"
          exit 1
          
      # Passo 7: Executar testes (incluindo testes Selenium)
      - name: Executar testes
        env:
          CI: true
        run: mvn test
        
      # Passo 8: Parar a aplicaÃ§Ã£o
      - name: Parar aplicaÃ§Ã£o
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            echo "AplicaÃ§Ã£o parada"
          fi
          # Mostra os logs da aplicaÃ§Ã£o para debug (se necessÃ¡rio)
          if [ -f app.log ]; then
            echo "=== Logs da aplicaÃ§Ã£o ==="
            cat app.log
          fi
        
      # Passo 9: Fazer upload dos arquivos gerados (artefatos)
      - name: Upload artefatos de build
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: target/*.jar
          retention-days: 7

  # Job de Deploy para Ambiente de Staging
  deploy-staging:
    name: Deploy - Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    if: |
      (github.ref == 'refs/heads/staging' || 
       github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') &&
      github.event_name != 'pull_request'
    environment:
      name: staging
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Java 21 e Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Download artefatos
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: target/
      
      - name: Executar testes de integraÃ§Ã£o adicionais
        run: |
          echo "ðŸ§ª Executando testes de integraÃ§Ã£o para staging..."
          # Adicione testes especÃ­ficos de staging aqui se necessÃ¡rio
      
      - name: Deploy para Staging
        env:
          DEPLOY_HOST: ${{ secrets.STAGING_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.STAGING_DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
          DEPLOY_PATH: ${{ secrets.STAGING_DEPLOY_PATH || '/opt/app/staging' }}
        run: |
          echo "ðŸš€ Iniciando deploy para ambiente de STAGING"
          echo "Host: $DEPLOY_HOST"
          echo "Path: $DEPLOY_PATH"
          
          # Exemplo de deploy via SSH (ajuste conforme sua infraestrutura)
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $DEPLOY_PATH"
          # scp -i "$DEPLOY_KEY" target/*.jar $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "systemctl restart app-staging || echo 'ServiÃ§o nÃ£o encontrado'"
          
          echo "âœ… Deploy para staging concluÃ­do com sucesso!"
          echo "ðŸ“ Nota: Configure os secrets STAGING_DEPLOY_HOST, STAGING_DEPLOY_USER, STAGING_DEPLOY_KEY no GitHub"
      
      - name: Smoke Tests pÃ³s-deploy
        run: |
          echo "ðŸ” Executando smoke tests..."
          # Adicione verificaÃ§Ãµes de saÃºde da aplicaÃ§Ã£o aqui
          # curl -f ${{ secrets.STAGING_ENVIRONMENT_URL }}/health || exit 1
      
      - name: NotificaÃ§Ã£o de Deploy
        if: success()
        run: |
          echo "âœ… Deploy para staging realizado com sucesso!"
          echo "ðŸ”— URL: ${{ secrets.STAGING_ENVIRONMENT_URL || 'NÃ£o configurada' }}"

  # Job de Deploy para Ambiente de ProduÃ§Ã£o
  deploy-production:
    name: Deploy - ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: build-and-test
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' ||
       github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') &&
      github.event_name != 'pull_request'
    environment:
      name: production
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Java 21 e Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Download artefatos
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: target/
      
      - name: Validar versÃ£o e tags
        run: |
          echo "ðŸ“‹ Validando informaÃ§Ãµes da versÃ£o..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          # Adicione validaÃ§Ãµes adicionais aqui
      
      - name: Criar tag de release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)
          echo "ðŸ·ï¸ Criando tag: v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release automÃ¡tico - $VERSION"
          git push origin "v$VERSION" || echo "Tag jÃ¡ existe ou sem permissÃ£o"
      
      - name: Deploy para ProduÃ§Ã£o
        env:
          DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.PROD_DEPLOY_KEY }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH || '/opt/app/prod' }}
        run: |
          echo "ðŸš€ Iniciando deploy para ambiente de PRODUÃ‡ÃƒO"
          echo "âš ï¸ ATENÃ‡ÃƒO: Este Ã© um deploy para produÃ§Ã£o!"
          echo "Host: $DEPLOY_HOST"
          echo "Path: $DEPLOY_PATH"
          
          # Exemplo de deploy via SSH (ajuste conforme sua infraestrutura)
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $DEPLOY_PATH"
          # scp -i "$DEPLOY_KEY" target/*.jar $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "systemctl restart app-prod || echo 'ServiÃ§o nÃ£o encontrado'"
          
          echo "âœ… Deploy para produÃ§Ã£o concluÃ­do com sucesso!"
          echo "ðŸ“ Nota: Configure os secrets PROD_DEPLOY_HOST, PROD_DEPLOY_USER, PROD_DEPLOY_KEY no GitHub"
      
      - name: Configurar Chrome para testes Selenium
        run: |
          echo "ðŸ”§ Configurando Chrome para testes Selenium..."
          google-chrome --version || echo "Chrome nÃ£o encontrado, mas WebDriverManager vai gerenciar"
          export DISPLAY=:99
      
      - name: Verificar dependÃªncias e compilar
        run: |
          echo "ðŸ“¦ Verificando dependÃªncias e compilando projeto..."
          mvn dependency:resolve
          mvn clean compile package -DskipTests
          echo "âœ… CompilaÃ§Ã£o concluÃ­da!"
      
      - name: Iniciar aplicaÃ§Ã£o em localhost
        run: |
          echo "ðŸš€ Iniciando aplicaÃ§Ã£o em localhost:8000..."
          
          # Inicia a aplicaÃ§Ã£o em background
          nohup mvn exec:java -Dexec.mainClass="org.example.App" > app-prod-test.log 2>&1 &
          APP_PID=$!
          echo $APP_PID > app-prod-test.pid
          echo "ðŸ“ PID da aplicaÃ§Ã£o: $APP_PID"
          sleep 5  # DÃ¡ um tempo inicial para o processo iniciar
          
          # Aguarda aplicaÃ§Ã£o estar pronta
          echo "â³ Aguardando aplicaÃ§Ã£o iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/items > /dev/null 2>&1; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ rodando em localhost:8000!"
              exit 0
            fi
            echo "   Tentativa $i/30 - aguardando aplicaÃ§Ã£o..."
            sleep 2
          done
          
          echo "âŒ ERRO: AplicaÃ§Ã£o nÃ£o iniciou a tempo!"
          if [ -f app-prod-test.log ]; then
            echo "=== Logs da aplicaÃ§Ã£o ==="
            cat app-prod-test.log
          fi
          exit 1
      
      - name: Verificar se aplicaÃ§Ã£o estÃ¡ respondendo
        run: |
          echo "ðŸ” Verificando se aplicaÃ§Ã£o estÃ¡ respondendo..."
          if curl -f http://localhost:8000/items > /dev/null 2>&1; then
            echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo corretamente!"
          else
            echo "âŒ ERRO: AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo!"
            if [ -f app-prod-test.log ]; then
              echo "=== Logs da aplicaÃ§Ã£o ==="
              cat app-prod-test.log
            fi
            exit 1
          fi
      
      - name: Testes Selenium pÃ³s-deploy em produÃ§Ã£o
        env:
          TEST_BASE_URL: http://localhost:8000
          CI: true
        run: |
          echo "ðŸ§ª Executando testes Selenium pÃ³s-deploy..."
          echo "ðŸ“ URL: http://localhost:8000"
          echo ""
          
          # Executa os testes
          mvn test -Dtest=PostDeployProductionTest
          
          echo "âœ… Testes Selenium pÃ³s-deploy concluÃ­dos!"
      
      - name: Parar aplicaÃ§Ã£o
        if: always()
        run: |
          echo "ðŸ›‘ Parando aplicaÃ§Ã£o..."
          if [ -f app-prod-test.pid ]; then
            PID=$(cat app-prod-test.pid)
            kill $PID 2>/dev/null || true
            sleep 2
            # ForÃ§a kill se ainda estiver rodando
            kill -9 $PID 2>/dev/null || true
            echo "âœ… AplicaÃ§Ã£o parada (PID: $PID)"
          fi
      
      - name: NotificaÃ§Ã£o de Deploy
        if: success()
        run: |
          echo "âœ… Deploy para produÃ§Ã£o realizado com sucesso!"
          echo "ðŸ”— AplicaÃ§Ã£o testada em: http://localhost:8000"
          echo "ðŸ“Š Testes Selenium pÃ³s-deploy executados e validados!"

