# Nome do workflow que aparecer√° na interface do GitHub Actions
name: CI/CD Pipeline - Staging e Produ√ß√£o

# Define os eventos que disparam a execu√ß√£o do workflow
on:
  push:
    branches: 
      - main
      - master
      - staging
  pull_request:
    branches: 
      - main
      - master
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        type: choice
        options:
          - staging
          - production

# Define vari√°veis de ambiente globais
env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Dmaven.repo.local=${{ github.workspace }}/.m2/repository'

# Define os jobs (tarefas) que ser√£o executados
jobs:
  # Job de Build e Testes - Executa sempre
  build-and-test:
    name: Build e Testes
    runs-on: ubuntu-latest
    
    steps:
      # Passo 1: Baixar o c√≥digo do reposit√≥rio
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        
      # Passo 2: Configurar o ambiente Java e Maven
      - name: Configurar Java 21 e Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
          
      # Passo 3: Configurar Chrome para testes Selenium
      - name: Configurar Chrome para testes Selenium
        run: |
          google-chrome --version || echo "Chrome n√£o encontrado, mas WebDriverManager vai gerenciar"
          export DISPLAY=:99
          
      # Passo 4: Compilar o projeto (sem executar testes ainda)
      - name: Compilar o projeto
        run: mvn clean compile package -DskipTests
          
      # Passo 5: Iniciar a aplica√ß√£o em background
      - name: Iniciar aplica√ß√£o em background
        run: |
          nohup mvn exec:java -Dexec.mainClass="org.example.App" > app.log 2>&1 &
          echo $! > app.pid
          sleep 3
          
      # Passo 6: Aguardar aplica√ß√£o estar pronta
      - name: Aguardar aplica√ß√£o estar pronta
        run: |
          echo "Aguardando aplica√ß√£o iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/items > /dev/null 2>&1; then
              echo "Aplica√ß√£o est√° pronta!"
              exit 0
            fi
            echo "Tentativa $i/30 - aguardando..."
            sleep 2
          done
          echo "Aplica√ß√£o n√£o iniciou a tempo!"
          exit 1
          
      # Passo 7: Executar testes (incluindo testes Selenium)
      - name: Executar testes
        env:
          CI: true
        run: mvn test
        
      # Passo 8: Parar a aplica√ß√£o
      - name: Parar aplica√ß√£o
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            echo "Aplica√ß√£o parada"
          fi
          # Mostra os logs da aplica√ß√£o para debug (se necess√°rio)
          if [ -f app.log ]; then
            echo "=== Logs da aplica√ß√£o ==="
            cat app.log
          fi
        
      # Passo 9: Fazer upload dos arquivos gerados (artefatos)
      - name: Upload artefatos de build
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: target/*.jar
          retention-days: 7

  # Job de Deploy para Ambiente de Staging
  deploy-staging:
    name: Deploy - Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    if: |
      (github.ref == 'refs/heads/staging' || 
       github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') &&
      github.event_name != 'pull_request'
    environment:
      name: staging
    
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Java 21 e Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Download artefatos
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: target/
      
      - name: Executar testes de integra√ß√£o adicionais
        run: |
          echo "üß™ Executando testes de integra√ß√£o para staging..."
          # Adicione testes espec√≠ficos de staging aqui se necess√°rio
      
      - name: Deploy para Staging
        env:
          DEPLOY_HOST: ${{ secrets.STAGING_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.STAGING_DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
          DEPLOY_PATH: ${{ secrets.STAGING_DEPLOY_PATH || '/opt/app/staging' }}
        run: |
          echo "üöÄ Iniciando deploy para ambiente de STAGING"
          echo "Host: $DEPLOY_HOST"
          echo "Path: $DEPLOY_PATH"
          
          # Exemplo de deploy via SSH (ajuste conforme sua infraestrutura)
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $DEPLOY_PATH"
          # scp -i "$DEPLOY_KEY" target/*.jar $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "systemctl restart app-staging || echo 'Servi√ßo n√£o encontrado'"
          
          echo "‚úÖ Deploy para staging conclu√≠do com sucesso!"
          echo "üìù Nota: Configure os secrets STAGING_DEPLOY_HOST, STAGING_DEPLOY_USER, STAGING_DEPLOY_KEY no GitHub"
      
      - name: Smoke Tests p√≥s-deploy
        run: |
          echo "üîç Executando smoke tests..."
          # Adicione verifica√ß√µes de sa√∫de da aplica√ß√£o aqui
          # curl -f ${{ secrets.STAGING_ENVIRONMENT_URL }}/health || exit 1
      
      - name: Notifica√ß√£o de Deploy
        if: success()
        run: |
          echo "‚úÖ Deploy para staging realizado com sucesso!"
          echo "üîó URL: ${{ secrets.STAGING_ENVIRONMENT_URL || 'N√£o configurada' }}"

  # Job de Deploy para Ambiente de Produ√ß√£o
  deploy-production:
    name: Deploy - Produ√ß√£o
    runs-on: ubuntu-latest
    needs: build-and-test
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' ||
       github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') &&
      github.event_name != 'pull_request'
    environment:
      name: production
    
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Java 21 e Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Download artefatos
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: target/
      
      - name: Validar vers√£o e tags
        run: |
          echo "üìã Validando informa√ß√µes da vers√£o..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          # Adicione valida√ß√µes adicionais aqui
      
      - name: Criar tag de release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)
          echo "üè∑Ô∏è Criando tag: v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release autom√°tico - $VERSION"
          git push origin "v$VERSION" || echo "Tag j√° existe ou sem permiss√£o"
      
      - name: Deploy para Produ√ß√£o
        env:
          DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.PROD_DEPLOY_KEY }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH || '/opt/app/prod' }}
        run: |
          echo "üöÄ Iniciando deploy para ambiente de PRODU√á√ÉO"
          echo "‚ö†Ô∏è ATEN√á√ÉO: Este √© um deploy para produ√ß√£o!"
          echo "Host: $DEPLOY_HOST"
          echo "Path: $DEPLOY_PATH"
          
          # Exemplo de deploy via SSH (ajuste conforme sua infraestrutura)
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $DEPLOY_PATH"
          # scp -i "$DEPLOY_KEY" target/*.jar $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          # ssh -i "$DEPLOY_KEY" $DEPLOY_USER@$DEPLOY_HOST "systemctl restart app-prod || echo 'Servi√ßo n√£o encontrado'"
          
          echo "‚úÖ Deploy para produ√ß√£o conclu√≠do com sucesso!"
          echo "üìù Nota: Configure os secrets PROD_DEPLOY_HOST, PROD_DEPLOY_USER, PROD_DEPLOY_KEY no GitHub"
      
      - name: Configurar Chrome para testes Selenium
        run: |
          echo "üîß Configurando Chrome para testes Selenium..."
          google-chrome --version || echo "Chrome n√£o encontrado, mas WebDriverManager vai gerenciar"
          export DISPLAY=:99
      
      - name: Testes Selenium p√≥s-deploy em produ√ß√£o
        env:
          TEST_BASE_URL: ${{ secrets.PROD_ENVIRONMENT_URL }}
          CI: true
        run: |
          echo "üß™ Executando testes Selenium p√≥s-deploy em produ√ß√£o..."
          
          if [ -z "$TEST_BASE_URL" ] || [ "$TEST_BASE_URL" = "" ]; then
            echo "‚ö†Ô∏è PROD_ENVIRONMENT_URL n√£o est√° configurado!"
            echo ""
            echo "   üìù Para demonstra√ß√£o, vamos iniciar a aplica√ß√£o localmente e testar..."
            echo "   (Em produ√ß√£o real, a aplica√ß√£o j√° estaria rodando no servidor)"
            echo ""
            
            # Inicia a aplica√ß√£o em background para os testes
            echo "üöÄ Iniciando aplica√ß√£o em localhost:8000 para testes..."
            nohup mvn exec:java -Dexec.mainClass="org.example.App" > app-prod-test.log 2>&1 &
            echo $! > app-prod-test.pid
            sleep 5
            
            # Aguarda aplica√ß√£o estar pronta
            echo "‚è≥ Aguardando aplica√ß√£o iniciar..."
            for i in {1..30}; do
              if curl -f http://localhost:8000/items > /dev/null 2>&1; then
                echo "‚úÖ Aplica√ß√£o est√° pronta em localhost:8000!"
                break
              fi
              echo "   Tentativa $i/30..."
              sleep 2
            done
            
            # Configura TEST_BASE_URL para localhost
            export TEST_BASE_URL="http://localhost:8000"
            echo "üìç Usando URL: $TEST_BASE_URL (modo demonstra√ß√£o)"
            echo ""
            
            # Executa os testes
            mvn test -Dtest=PostDeployProductionTest || echo "‚ö†Ô∏è Alguns testes podem ter falhado"
            
            # Para a aplica√ß√£o
            if [ -f app-prod-test.pid ]; then
              kill $(cat app-prod-test.pid) 2>/dev/null || true
              echo "üõë Aplica√ß√£o parada"
            fi
            
            echo ""
            echo "üí° Para testar em produ√ß√£o real:"
            echo "   1. Configure PROD_ENVIRONMENT_URL no GitHub Secrets"
            echo "   2. A aplica√ß√£o deve estar rodando no servidor de produ√ß√£o"
            echo "   3. Os testes v√£o acessar a URL de produ√ß√£o automaticamente"
          else
            echo "üìç URL de produ√ß√£o configurada: $TEST_BASE_URL"
            echo "   Aguardando aplica√ß√£o estar pronta no servidor (30 segundos)..."
            sleep 30  # Aguarda aplica√ß√£o iniciar ap√≥s deploy no servidor
            
            # Executa apenas os testes de p√≥s-deploy em produ√ß√£o
            mvn test -Dtest=PostDeployProductionTest
          fi
          
          echo "‚úÖ Testes Selenium p√≥s-deploy conclu√≠dos!"
      
      - name: Notifica√ß√£o de Deploy
        if: success()
        run: |
          echo "‚úÖ Deploy para produ√ß√£o realizado com sucesso!"
          echo "üîó URL: ${{ secrets.PROD_ENVIRONMENT_URL || 'N√£o configurada' }}"
          echo "üìä Monitoramento: Verifique os logs e m√©tricas da aplica√ß√£o"

